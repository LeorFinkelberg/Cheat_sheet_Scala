\documentclass[%
	11pt,
	a4paper,
	utf8,
	%twocolumn
		]{article}	

\usepackage{style_packages/podvoyskiy_article_extended}


\begin{document}
\title{Заметки. Практика использования и наиболее полезные конструкции языка \texttt{Scala}}

\author{\itshape Подвойский А.О.}

\date{}
\maketitle

\thispagestyle{fancy}

Здесь приводятся заметки по некоторым вопросам, касающимся машинного обучения, анализа данных, программирования на языках \texttt{Scala} и прочим сопряженным вопросам так или иначе, затрагивающим работу с данными.


%\shorttableofcontents{Краткое содержание}{1}

\tableofcontents

\section{Установка SDK}

SDKMAN (Software Development Kit Manager) \url{https://sdkman.io/} -- Очень полезная утилита для работы scala-средой.

\begin{lstlisting}[
style = bash,
numbers = none	
]
curl -s "https://get.sdkman.io" | bash
source "$HOME/.sdkman/bin/sdkman-init.sh"
sdk version
\end{lstlisting}

\section{Установка библиотек для Scala}

Например, библиотеку \texttt{breeze} \url{https://github.com/scalanlp/breeze/wiki/Installation}, близкую по своему функционалу к библиотеке \texttt{numpy} языка \texttt{Python}, можно установить с помощью \texttt{sbt} следующим образом
\begin{lstlisting}[
style = scala,
title = {\sffamily build.sbt},
numbers = none	
]
name := "project_name"
version := "0.1"
scalaVersion := "2.13.3"

libraryDependencies ++= Seq(
    // Last stable release
    "org.scalanlp" %% "breeze" % "1.1",
    // Native libraries are not included by default. add this if you want them
    // Native libraries greatly improve performance, but increase jar sizes. 
    // It also packages various blas implementations, which have licenses that may or may not
    // be compatible with the Apache License. No GPL code, as best I know.
    "org.scalanlp" %% "breeze-natives" % "1.1",
    // The visualization library is distributed separately as well.
    // It depends on LGPL code
    "org.scalanlp" %% "breeze-viz" % "1.1"
)
\end{lstlisting}

Если используется IDE IntelliJ IDEA, то файл \texttt{build.sbt} должен располагаться в директории проекта, например, \directory{C: > Users > ADM > IdeaProjects > project\_name}. Тогда после запуска сессии IDEA будут доступны все библиотеки.

Теперь можно запустить сессию в директории с файлом \texttt{build.sbt} командной
\begin{lstlisting}[
style = bash,
numbers = none
]
$ sbt console
scala> import breeze.linalg._
scala> val v = DenseVector(1.0, 2.0, 3.0)
\end{lstlisting}

К слову, есть полезная шпаргалка по \texttt{breeze} \url{https://github.com/scalanlp/breeze/wiki/Linear-Algebra-Cheat-Sheet}

\section{Базовый sbt-файл}

Зависимости проекта описываются в файле \textsf{build.sbt}

\begin{lstlisting}[
title = {\sffamily build.sbt},
style = scala,
numbers = none	
]
scalaVersion := "2.13.3"

libraryDependencies ++= Seq(
  "org.scalanlp" %% "breeze" % "1.1",
  "org.scalanlp" %% "breeze-natives" % "1.1",
  "org.scalanlp" %% "breeze-viz" % "1.1",
  "org.plotly-scala" %% "plotly-render" % "0.8.0",
  //"org.apache.spark" %% "spark-core" % "2.2.3" % "provided",
  //"org.apache.spark" %% "spark-sql" % "2.2.3" % "provided",
  //"org.vegas-viz" %% "vegas" % "0.3.11"
)
\end{lstlisting}


\section{Компиляция программ на Scala}

Пусть есть программа такая программа
\begin{lstlisting}[
style = scala,
numbers = none	
]
object Hello extends App {
	println("Hello, world")
}
\end{lstlisting}

Скомпилировать эту программу можно с помощью утилиты командной строки \texttt{scalac}
\begin{lstlisting}[
style = bash,
numbers = none	
]
scalac Hello.scala
\end{lstlisting}

Затем можно запустить программу с помощью утилиты командной строки \texttt{scala} $ {}^{\circ} $
\begin{lstlisting}[
style = bash,
numbers = none	
]
scala Hello
\end{lstlisting}

После этого в рабочей директории появятся файлы с расширениями \texttt{Hello.class}, \texttt{'Hello\$.class'}, \texttt{'Hello\$delayedInit\$body.class'}

\section{Работа с языком Scala в JupyterLab}

Для того, чтобы JupyterLab поддерживал код на Scala требуется установить ядро \texttt{spylon-kernel}
\begin{lstlisting}[
style = bash,
numbers = none	
]
# Step 1: Install spylon kernel
pip install spylon-kernel

# Step 2: create a kernel spec
python -m spylon_kernel install

# Step 3: start jupyter notebook 
jupyter notebook
\end{lstlisting}

Посмотреть установленные ядра можно так
\begin{lstlisting}[
style = bash,
numbers = none	
]
jupyter kernelspec list
\end{lstlisting}

В некотрых случаях удобнее работать с almond \url{https://almond.sh/docs/try-docker} -- это Scala-ядро для Jupyter. Проще всего воспользоваться docker-образом
\begin{lstlisting}[
style = bash,
numbers = none	
]
docker run -it --rm -p 8888:8888 almondsh/almond:latest
\end{lstlisting}

Можно указать конкретную версию almond или Scala
\begin{lstlisting}[
style = bash,
numbers = none	
]
docker run -it --rm -p 8888:8888 almondsh/almond:0.10.9
docker run -it --rm -p 8888:8888 almondsh/almond:0.10.9-scala-2.12.8
\end{lstlisting}

Затем нужно будет открыть в браузере вкладку с адресом, который будет указан в логах. Для примера начнем работу с библиотекой \texttt{plotly} \url{https://github.com/alexarchambault/plotly-scala}
\begin{lstlisting}[
title = {\sffamily в сеансе Jupyter},
style = scala,
numbers = none	
]
import $ivy.`org.plotly-scala::plotly-almond:0.8.0` // <-- NB: динамическое подключение библиотеки
import plotly._
import plotly.element._
import plotly.layout._
import plotly.Almond._

val (x, y) = Seq(
  "Banana" -> 10,
  "Apple" -> 8,
  "Grapefruit" -> 5
).unzip

Bar(x, y).plot()
\end{lstlisting}

Узнать домашнюю директорию Spark можно так
\begin{lstlisting}[
style = bash,
numbers = none	
]
echo 'sc.getConf.get("spark.home")' | spark-shell
\end{lstlisting}

Для поддержки Spark в almond необходимо добавить следующие строки (ВАЖНО: ядро и кластер Spark должны использовать одну и ту же версию Scala) \url{https://github.com/almond-sh/almond/blob/master/docs/pages/usage-spark.md}
\begin{lstlisting}[
style = scala,
title = {\sffamily в сеансе Jupyter. Для поддержки Spark},
numbers = none	
]
import $ivy.`org.apache.spark::spark-sql:2.4.0` // Or use any other 2.x version here
import $ivy.`sh.almond::almond-spark:@VERSION@` // Not required since almond 0.7.0 (will be automatically added when importing spark)
\end{lstlisting}

В самом простом случае можно воспользоваться web-интерфейсом \texttt{binder} \url{https://mybinder.org/}, доступного на странице проекта almond (по состоянию на 02.12.20 Spark совместим только с версией Scala 2.11).

Подключить \texttt{breeze} в сеансе JupyterLab на базе binder можно такой конструкцией
\begin{lstlisting}[
style = scala,
numbers = none	
]
import $ivy.`org.scalanlp::breeze:1.0`

import breeze.linalg.{DenseMatrix, DenseVector}
import breeze.stats.regression.{leastSquares, lasso}
...
\end{lstlisting}

\section{Работа со Scala через Ammonite}

\texttt{Ammonite} \url{https://ammonite.io/} на высоком уровне абстракции (очень грубо) представляет собой командную REPL-оболочку для Scala (на самом деле возможности гораздо шире).


\section{Приемы использования библиотеки Breeze}

Быстрое введение в библиотеку \texttt{Breeze} можно найти здесь \url{https://github.com/scalanlp/breeze/wiki/Quickstart}, а шпаргалку по работе с инструментами линейной алгебры по адресу \url{https://github.com/scalanlp/breeze/wiki/Linear-Algebra-Cheat-Sheet}.

Чтобы создать полносвязанный вектор или матрицу можно воспользоваться следующими приемами
\begin{lstlisting}[
style = scala,
numbers = none	
]
import breeze.linalg._

DenseVector.ones[Double](5) 
// np.ones(5) <-- numpy

DenseVector.fill(3){5}  // или просто DenseVector.fill(3)(5)
// np.ones(3)*5 <-- numpy

DenseVector.fill(3){scala.math.sin(10)}
// np.ones(3)*np.sin(10)

DenseMatrix.ones[Double](3,2)
// np.ones((3,2)) <-- numpy

DenseMatrix((1.0, 2.0), (3.0, 4.0))
// np.array([[1.0, 2.0], [3.0, 4.0]]) <-- numpy
\end{lstlisting}

Для диапазона
\begin{lstlisting}[
style = scala,
numbers = none	
]
linspace(1,5,10)
// np.linspace(1,5,10 <-- numpy)
\end{lstlisting}

Транспонирование векторов и матриц
\begin{lstlisting}[
style = scala,
numbers = none	
]
DenseVector(1.to(5): _*).t
// np.array(range(1,6)).reshape(-1, 1)

DenseMatrix((10, 20, 30), (40, 50, 60)).t
// np.array([[10, 20, 30], [40, 50, 60]]).T
\end{lstlisting}

Можно использовать приемы генерации значений таблицы на лету
\begin{lstlisting}[
style = scala,
numbers = none	
]
DenseMatrix.tabulate(3, 2){ case (i, j) => i + j}
\end{lstlisting}

На ванильном Python генерацию на лету можно было бы реализовать так
\begin{lstlisting}[
style = IronPython,
emph = {tabulate},
numbers = none	
]
def tabulate(n: int, m: int) -> np.array:
    arr = []
    for i in range(n):
        row = []
        for j in range(m):
            row.append(i + j)
        arr.append(row)
    return np.array(arr)
\end{lstlisting}

Создать матрицу на базе массива можно так
\begin{lstlisting}[
style = scala,
numbers = none	
]
val mtx = new DenseMatrix(2, 3, Array[Int](10, 20, 30, 40, 50, 60)) // обязательно new!
\end{lstlisting}

Для создания векторов и матриц, заполненных равномерно распределенными псевдослучайными числами используется метод \texttt{rand}
\begin{lstlisting}[
style = scala,
numbers = none	
]
DenseVector.rand(3)
// np.random.rand(3)
// или
DenseMatrix.rand(3, 2)
// np.random.rand(3, 2)
\end{lstlisting}

Чтение и запись векторов и матриц
\begin{lstlisting}[
style = scala,
numbers = none	
]
val mtx = DenseMatrix.rand(3, 2)
mtx(1, 1) // 1-ая строка и 1-ый столбец

val v = DenseVector.rand(10)
v.slice(1,5) // или a(1 to 4) или a(1 until 5)
// v[1:5] <-- numpy; правая граница не включается!

v(5 to 0 by -1)
// v[5::-1]

v(1 to -1) // v[1:]

v(-1) // v[-1] последний элемент

v(::, 2) // v[:, 2]
\end{lstlisting}

Примеры других манипуляций
\begin{lstlisting}[
style = scala,
numbers = none	
]
mtx.reshape(3, 2) // как и в numpy

// разворачивание матрицы в вектор
mtx.toDenseVector // mtx.flatten()

// копирование нижнего треугольника данных
lowerTriangular(mtx) // np.tril(mtx)

// копирование верхнего треугольника данных
upperTriangular(mtx) // np.triu(mtx)

// верхнеуровневое копирование
mtx.copy // np.copy(mtx)

// выбрать диагональные элементы матрицы
diag(mtx) // np.diagonal(mtx)


\end{lstlisting}



%\listoffigures\addcontentsline{toc}{section}{Список иллюстраций}

% Источники в "Газовой промышленности" нумеруются по мере упоминания 
\begin{thebibliography}{99}\addcontentsline{toc}{section}{Список литературы}
	\bibitem{hostmann:scala-2013}{{\emph{Хостаманн К.} Scala для нетерпеливых. -- М.: ДМК Пресс, 2013. -- 408~с. }
\end{thebibliography}

\end{document}
